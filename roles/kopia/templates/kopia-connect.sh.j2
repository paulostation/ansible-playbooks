#!/bin/bash
set -e

CONFIG_FILE="{{ kopia_config_dir }}/kopia.sops.yaml"

# SOPS decryption setup
{% if kopia_sops_method == "kms" %}
# Using AWS KMS for SOPS decryption
{% if kopia_aws_profile %}
export AWS_PROFILE={{ kopia_aws_profile }}
{% endif %}
{% else %}
# Using age key for SOPS decryption
export SOPS_AGE_KEY_FILE={{ kopia_sops_age_key_file }}
{% endif %}

# Read values from SOPS-encrypted config file
export KOPIA_PASSWORD=$(sops -d --extract '["kopia"]["repository_password"]' "$CONFIG_FILE")
ACCESS_KEY=$(sops -d --extract '["kopia"]["access_key_id"]' "$CONFIG_FILE")
SECRET_KEY=$(sops -d --extract '["kopia"]["secret_access_key"]' "$CONFIG_FILE")
ENDPOINT=$(sops -d --extract '["kopia"]["endpoint"]' "$CONFIG_FILE")
BUCKET=$(sops -d --extract '["kopia"]["bucket"]' "$CONFIG_FILE")

echo "Connecting to kopia repository..."
echo "  Endpoint: $ENDPOINT"
echo "  Bucket: $BUCKET"

# Use env var for password instead of --password flag
kopia repository connect s3 \
  --bucket="$BUCKET" \
  --endpoint="$ENDPOINT" \
  --access-key="$ACCESS_KEY" \
  --secret-access-key="$SECRET_KEY" \
  "$@"
