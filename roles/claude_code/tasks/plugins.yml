---
# Configure Claude Code plugins (obra/superpowers)

- name: Ensure Claude Code config directory exists
  become: false
  file:
    path: "{{ claude_code_config_dir }}"
    state: directory
    owner: "{{ claude_code_user }}"
    mode: "0755"

- name: Check if settings.json exists
  stat:
    path: "{{ claude_code_config_dir }}/settings.json"
  register: settings_file

- name: Create settings.json with plugin config (if not exists)
  become: false
  copy:
    dest: "{{ claude_code_config_dir }}/settings.json"
    content: |
      {
        "plugins": {
          "marketplaces": ["obra/superpowers-marketplace"],
          "installed": ["superpowers@superpowers-marketplace"]
        }
      }
    mode: "0644"
  when: not settings_file.stat.exists

- name: Update existing settings.json with plugin config
  become: false
  shell: |
    export PATH="$HOME/.claude/local/bin:$PATH"
    claude /plugin marketplace add obra/superpowers-marketplace || true
    claude /plugin install superpowers@superpowers-marketplace || true
  when: settings_file.stat.exists
  changed_when: false
  failed_when: false

- name: Display post-install instructions
  debug:
    msg: |
      Claude Code installed! To complete setup:
      1. Run 'claude' to authenticate via OAuth
      2. Superpowers plugin is pre-configured and will auto-install
      3. Verify with '/help' to see superpowers commands
