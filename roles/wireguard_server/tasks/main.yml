---
# WireGuard Server Role - Main Tasks

- name: Install WireGuard packages
  ansible.builtin.apt:
    name:
      - wireguard
      - wireguard-tools
    state: present
    update_cache: true
  become: true

- name: Ensure WireGuard directory exists
  ansible.builtin.file:
    path: /etc/wireguard
    state: directory
    mode: '0700'
    owner: root
    group: root
  become: true

- name: Check if private key exists
  ansible.builtin.stat:
    path: /etc/wireguard/privatekey
  register: wg_privatekey
  become: true

- name: Generate WireGuard private key
  ansible.builtin.shell: wg genkey
  register: wg_genkey
  when: not wg_privatekey.stat.exists
  become: true
  changed_when: true

- name: Save private key
  ansible.builtin.copy:
    content: "{{ wg_genkey.stdout }}"
    dest: /etc/wireguard/privatekey
    mode: '0600'
    owner: root
    group: root
  when: not wg_privatekey.stat.exists
  become: true
  no_log: true

- name: Read private key
  ansible.builtin.slurp:
    src: /etc/wireguard/privatekey
  register: wg_privatekey_content
  become: true
  no_log: true

- name: Generate public key from private key
  ansible.builtin.shell: echo "{{ wg_privatekey_content.content | b64decode | trim }}" | wg pubkey
  register: wg_pubkey
  changed_when: false
  become: true
  no_log: true

- name: Save public key
  ansible.builtin.copy:
    content: "{{ wg_pubkey.stdout }}"
    dest: /etc/wireguard/publickey
    mode: '0644'
    owner: root
    group: root
  become: true

- name: Display server public key
  ansible.builtin.debug:
    msg: "WireGuard server public key: {{ wg_pubkey.stdout }}"

- name: Configure WireGuard interface
  ansible.builtin.template:
    src: wg0.conf.j2
    dest: "/etc/wireguard/{{ wireguard_interface }}.conf"
    mode: '0600'
    owner: root
    group: root
  become: true
  notify: Restart WireGuard

- name: Enable IP forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: true
    state: present
    reload: true
  become: true
  when: wireguard_ip_forward

- name: Disable IPv6
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: '1'
    sysctl_set: true
    state: present
    reload: true
  loop:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
  become: true

- name: Enable and start WireGuard
  ansible.builtin.systemd:
    name: "wg-quick@{{ wireguard_interface }}"
    enabled: true
    state: started
  become: true
