---
# Binary installation method
- name: Install yazi from GitHub binary release
  when: yazi_install_method == "binary"
  become: true
  block:
    - name: Get latest yazi release version
      ansible.builtin.uri:
        url: https://api.github.com/repos/sxyazi/yazi/releases/latest
        return_content: true
      register: yazi_release

    - name: Set yazi version fact
      ansible.builtin.set_fact:
        yazi_version: "{{ yazi_release.json.tag_name }}"

    - name: Download yazi binary
      ansible.builtin.unarchive:
        src: "https://github.com/sxyazi/yazi/releases/download/{{ yazi_version }}/yazi-x86_64-unknown-linux-gnu.zip"
        dest: /tmp
        remote_src: true
      register: yazi_download

    - name: Install yazi binary
      ansible.builtin.copy:
        src: /tmp/yazi-x86_64-unknown-linux-gnu/yazi
        dest: "{{ yazi_install_dir }}/yazi"
        mode: "0755"
        remote_src: true

    - name: Install ya binary (yazi cli helper)
      ansible.builtin.copy:
        src: /tmp/yazi-x86_64-unknown-linux-gnu/ya
        dest: "{{ yazi_install_dir }}/ya"
        mode: "0755"
        remote_src: true

    - name: Cleanup temporary files
      ansible.builtin.file:
        path: /tmp/yazi-x86_64-unknown-linux-gnu
        state: absent

# Cargo installation method (fallback)
- name: Install yazi using cargo
  when: yazi_install_method == "cargo"
  become: true
  become_user: "{{ yazi_user }}"
  block:
    - name: Check if cargo is installed
      ansible.builtin.command: which cargo
      register: cargo_check
      changed_when: false
      failed_when: false

    - name: Install rustup if cargo not found
      when: cargo_check.rc != 0
      ansible.builtin.shell: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      args:
        executable: /bin/bash
        creates: "{{ yazi_cargo_home }}/bin/cargo"

    - name: Install yazi via cargo
      ansible.builtin.shell: |
        source {{ yazi_cargo_home }}/env
        cargo install --locked yazi-fm yazi-cli
      args:
        executable: /bin/bash
      environment:
        CARGO_HOME: "{{ yazi_cargo_home }}"

# Shell integration
- name: Add yazi shell integration to .zshrc
  when: yazi_shell == "zsh" or yazi_shell == "both"
  become: true
  become_user: "{{ yazi_user }}"
  ansible.builtin.blockinfile:
    path: "/home/{{ yazi_user }}/.zshrc"
    marker: "# {mark} YAZI SHELL INTEGRATION"
    block: |
      function yy() {
          local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
          yazi "$@" --cwd-file="$tmp"
          if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
              cd -- "$cwd"
          fi
          rm -f -- "$tmp"
      }
    state: present
    create: true

- name: Add yazi shell integration to .bashrc
  when: yazi_shell == "bash" or yazi_shell == "both"
  become: true
  become_user: "{{ yazi_user }}"
  ansible.builtin.blockinfile:
    path: "/home/{{ yazi_user }}/.bashrc"
    marker: "# {mark} YAZI SHELL INTEGRATION"
    block: |
      function yy() {
          local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
          yazi "$@" --cwd-file="$tmp"
          if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
              cd -- "$cwd"
          fi
          rm -f -- "$tmp"
      }
    state: present
    create: true
