# {{ ansible_managed }}
# Vector configuration - generated by Ansible

data_dir: {{ vector_data_dir }}

api:
  enabled: {{ vector_api_enabled | lower }}
  address: {{ vector_api_address }}

sources:
{% for source_name, source_config in vector_sources.items() %}
  {{ source_name }}:
{% for key, value in source_config.items() %}
{% if value is mapping %}
    {{ key }}:
{% for subkey, subvalue in value.items() %}
      {{ subkey }}: {{ subvalue | to_json }}
{% endfor %}
{% elif value is iterable and value is not string %}
    {{ key }}:
{% for item in value %}
      - {{ item | to_json }}
{% endfor %}
{% else %}
    {{ key }}: {{ value | to_json }}
{% endif %}
{% endfor %}
{% endfor %}

transforms:
  add_host:
    type: remap
    inputs:
{% for source_name in vector_sources.keys() %}
      - {{ source_name }}
{% endfor %}
    source: |
      .host = "{{ vector_host_identifier }}"
      .source_type = "vector-agent"

{% if vector_extra_transforms %}
{% for transform_name, transform_config in vector_extra_transforms.items() %}
  {{ transform_name }}:
{% for key, value in transform_config.items() %}
{% if value is mapping %}
    {{ key }}:
{% for subkey, subvalue in value.items() %}
      {{ subkey }}: {{ subvalue | to_json }}
{% endfor %}
{% elif value is iterable and value is not string %}
    {{ key }}:
{% for item in value %}
      - {{ item | to_json }}
{% endfor %}
{% else %}
    {{ key }}: {{ value | to_json }}
{% endif %}
{% endfor %}
{% endfor %}
{% endif %}

sinks:
  aggregator:
    type: vector
    inputs:
{% if vector_extra_transforms %}
      - {{ (vector_extra_transforms.keys() | list)[-1] }}
{% else %}
      - add_host
{% endif %}
    address: {{ vector_aggregator_address }}
    version: "{{ vector_aggregator_version }}"
    healthcheck:
      enabled: {{ vector_healthcheck_enabled | lower }}
{% if vector_mtls_enabled %}
    tls:
      enabled: true
      ca_file: {{ vector_ca_file }}
      crt_file: {{ vector_cert_file }}
      key_file: {{ vector_key_file }}
      verify_certificate: {{ vector_verify_certificate | lower }}
      verify_hostname: {{ vector_verify_hostname | lower }}
{% endif %}
